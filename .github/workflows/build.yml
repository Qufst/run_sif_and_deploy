name: from-singularity-deploy-papers

on:
  push:
    branches: ["main"]
  repository_dispatch:
    types: [custom-event] 
  workflow_dispatch:

permissions: 
  contents: write
  pages: write

jobs:
  download-singularity-image:
    name: Download Singularity Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure Git
        run: |
          git config --global user.email "quentin.festor@etu.umontpellier.com"
          git config --global user.name "quarto-github-actions"

      - uses: eWaterCycle/setup-apptainer@v2
        with:
          apptainer-version: 1.3.2

      - name: Download Singularity image artifact
        run: |
          gh run download 10160047868 -n apptainer-image -R Qufst/create_apptainer.sif
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: sandbox
        run: |
          apptainer build --sandbox temp_sandbox image_quarto.sif   
          
      - name: exec
        run: |
          apptainer exec --writable temp_sandbox touch install_quarto.sh
          apptainer exec --writable temp_sandbox echo "#!/bin/bash" >> install_quarto.sh
          apptainer exec --writable temp_sandbox echo "QUARTO_VERSION=1.5.55" >> ./install_quarto.sh
          apptainer exec --writable temp_sandbox echo "mkdir -p /opt/quarto" >> ./install_quarto.sh
          apptainer exec --writable temp_sandbox echo "wget -qO- quarto-1.5.55-linux-amd64.tar.gz https://github.com/quarto-dev/quarto-cli/releases/download/v1.5.55/quarto-1.5.55-linux-amd64.tar.gz" >> ./install_quarto.sh
          apptainer exec --writable temp_sandbox echo "tar -xz -C /opt/quarto --strip-components=1 -f quarto-1.5.55-linux-amd64.tar.gz" >> ./install_quarto.sh
          apptainer exec --writable temp_sandbox chmod +x ./install_quarto.sh
          apptainer exec --writable temp_sandbox ls -la
          apptainer exec --writable temp_sandbox cat ./install_quarto.sh
          apptainer exec --writable temp_sandbox bash -c ./install_quarto.sh
          apptainer exec --writable temp_sandbox quarto check


      - name: Creation of xdg_runtime_dir
        run: |
          mkdir -p xdg_runtime_dir
          export XDG_RUNTIME_DIR=~/xdg_runtime_dir 
          
      - name: render
        run: |

          apptainer exec --writable temp_sandbox echo 'export PATH=/opt/quarto/bin:$PATH' >> /etc/profile
          apptainer exec temp_sandbox export PATH=/opt/quarto/bin:$PATH
          apptainer exec image_r.sif quarto render index.qmd


      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages



#gh run download 10005971130 -n apptainer-image -R Qufst/create_apptainer.sif
#gh run download 10112698165 -n apptainer-image -R Qufst/create_apptainer.sif
#gh auth login

